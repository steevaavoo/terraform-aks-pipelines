trigger:
  batch: "true"
  branches:
    include:
    - master
    - develop

# A pull request will not trigger a build
pr: none

resources:
- repo: self

variables:
  poolName: 'ubuntu-latest'
  terraformstoragerg: 'terraformrg'
  terraformstorageaccount: 'terraformstoragestv22f79'
  serviceConnection: 'aks_sc'

stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: Build
    displayName: Build job
    pool:
      vmImage\: $(poolName)
    steps:
    - task: CopyFiles@2
      displayName: 'Copy Terraform files to artifacts'
      inputs:
        SourceFolder: terraform
        TargetFolder: '$(Build.ArtifactStagingDirectory)/Terraform'

    - task: CopyFiles@2
      displayName: 'Copy K8s YAML files to artifacts'
      inputs:
        SourceFolder: manifests
        TargetFolder: '$(Build.ArtifactStagingDirectory)/manifests'

    - publish: $(Build.ArtifactStagingDirectory)
      artifact: drop

- stage: Deploy
  jobs:
    # track deployments on the environment
  - deployment: 'NginxDemo_Release_Pipeline'
    pool:
      vmImage: $(poolName)
    # creates an environment if it doesnâ€™t exist
    environment: 'dev'
    strategy:
      # default deployment strategy
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@1
            displayName: 'Azure CLI to deploy Storage for Terraform Remote'
            inputs:
              azureSubscription: $(serviceConnection)
              scriptLocation: inlineScript
              inlineScript: |
                # the following script will create an Azure resource group, Storage account and Storage container which will be used to store terraform remote state

                az group create --location eastus --name $(terraformstoragerg)

                az storage account create --name $(terraformstorageaccount) --resource-group $(terraformstoragerg) --location eastus --sku Standard_LRS

                az storage container create --name terraform --account-name $(terraformstorageaccount)

          - task: AzurePowerShell@3
            displayName: 'Azure PowerShell script to get Storage Key'
            inputs:
              azureSubscription: $(serviceConnection)
              ScriptType: InlineScript
              Inline: |
                # Using this script we will fetch the storage key which is required in our Terraform file to authenticate to the backend storage account

                $key=(Get-AzureRmStorageAccountKey -ResourceGroupName $(terraformstoragerg) -AccountName $(terraformstorageaccount)).Value[0]

                Write-Host "##vso[task.setvariable variable=storagekey]$key"

                azurePowerShellVersion: LatestVersion
